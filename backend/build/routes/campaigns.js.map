{"version":3,"sources":["../../src/routes/campaigns.js"],"names":["CLOUDINARY_NAME","CLOUDINARY_KEY","CLOUDINARY_SECRET","config","parsed","cloud_name","api_key","api_secret","upload","router","get","req","res","Object","keys","query","length","search","sort","send","id","params","campaignId","results","error","patch","console","log","body","post","single","campaignName","imageType","imageAlt","nonprofitId","image","file","imageDimensions","imgType","width","height","dimensions","originalName","originalname","fileName","substring","lastIndexOf","Date","toISOString","public_id","folder","tags","success","http_code","message","newCampaign","accessToken","user","app_metadata","nonProfitID","statusCode","original"],"mappings":";;;;;;kQAAA;;;AACA;;AACA;;;;AAEA;;;;AACA;;;;AAEA;;AACA;;AACA;;;;AACA;;;;AACA;;;;;;AAGA,MAAM,EAAEA,eAAF,EAAmBC,cAAnB,EAAmCC,iBAAnC,KAAyD,iBAAOC,MAAP,GAAgBC,MAA/E;;AAEA,qBAAWD,MAAX,CAAkB;AAChBE,cAAYL,eADI;AAEhBM,WAASL,cAFO;AAGhBM,cAAYL;AAHI,CAAlB;;AAMA,MAAMM,SAAS,uBAAf;AACA,MAAMC,SAAS,sBAAf;;AAEA;;;;AAIA;AACAA,OAAOC,GAAP,CAAW,GAAX,EAAgB,CAACC,GAAD,EAAMC,GAAN,KAAc;AAC5B,MAAIC,OAAOC,IAAP,CAAYH,IAAII,KAAhB,EAAuBC,MAAvB,GAAgC,CAApC,EAAuC;AACrC,UAAMC,SAASN,IAAII,KAAJ,CAAUE,MAAzB;AACA,UAAMC,OAAOP,IAAII,KAAJ,CAAUG,IAAvB;AACA,QAAIA,QAAQD,MAAZ,EAAoB;AAClBL,UAAIO,IAAJ,CAAU;wCACwBF,MAAO,kBAAiBC,IAAK;OAD/D;AAGD,KAJD,MAIO,IAAIA,IAAJ,EAAU;AACfN,UAAIO,IAAJ,CAAU;0CAC0BD,IAAK;OADzC;AAGD,KAJM,MAIA,IAAID,MAAJ,EAAY;AACjBL,UAAIO,IAAJ,CAAU;wCACwBR,IAAII,KAAJ,CAAUE,MAAO;OADnD;AAGD;AACF,GAhBD,MAgBO;AACLL,QAAIO,IAAJ,CAAS,kCAAT;AACD;AACF,CApBD;;AAsBA;AACAV,OAAOC,GAAP,CAAW,cAAX,EAA2B,CAACC,GAAD,EAAMC,GAAN,KAAc;AACvC,QAAMQ,KAAKT,IAAIU,MAAJ,CAAWC,UAAtB;AACA,qCACEF,EADF,EAEEG,WAAW,wBACT,GADS,EAETA,OAFS,EAGR,2CAA0CH,EAAG,EAHrC,EAITR,GAJS,CAFb,EAQGY,KAAD,IAAW;AACT,QAAIX,OAAOC,IAAP,CAAYU,KAAZ,EAAmBR,MAAvB,EAA+B;AAC7B,aAAO,wBACL,GADK,EAELQ,KAFK,EAGL,mCAHK,EAILZ,GAJK,CAAP;AAMD;AACD,WAAO,wBACL,GADK,EAELY,KAFK,EAGL,0DAHK,EAILZ,GAJK,CAAP;AAMD,GAvBH;AAyBD,CA3BD;;AA6BA;AACA;AACAH,OAAOgB,KAAP,CAAa,mBAAb,EAAkC,CAACd,GAAD,EAAMC,GAAN,KAAc;AAC9C,QAAMQ,KAAKT,IAAIU,MAAJ,CAAWC,UAAtB;AACAI,UAAQC,GAAR,CAAYhB,IAAIiB,IAAhB;AACD,CAHD;;AAKAnB,OAAOoB,IAAP,CAAY,2BAAZ,EAAyCrB,OAAOsB,MAAP,CAAc,MAAd,CAAzC,EAAgE,CAACnB,GAAD,EAAMC,GAAN,KAAc;AAC5E,QAAMQ,KAAKT,IAAIU,MAAJ,CAAWC,UAAtB;AACA,QAAM,EAAES,YAAF,EAAgBC,SAAhB,EAA2BC,QAA3B,EAAqCC,WAArC,KAAqDvB,IAAIiB,IAA/D;AACA,QAAMO,QAAQxB,IAAIyB,IAAlB;;AAEA,QAAMC,kBAAmBC,OAAD,IAAa;AACnC,YAAQA,OAAR;AACE,WAAK,MAAL;AACE,eAAO,EAAEC,OAAO,IAAT,EAAeC,QAAQ,GAAvB,EAAP;AACF,WAAK,MAAL;AACE,eAAO,EAAED,OAAO,GAAT,EAAcC,QAAQ,GAAtB,EAAP;AACF,WAAK,OAAL;AACE,eAAO,EAAED,OAAO,GAAT,EAAcC,QAAQ,GAAtB,EAAP;AACF;AACE,eAAO,EAAED,OAAO,GAAT,EAAcC,QAAQ,GAAtB,EAAP;AARJ;AAUD,GAXD;;AAaA,QAAMC,aAAaJ,gBAAgBL,SAAhB,CAAnB;AACA,QAAMU,eAAeP,MAAMQ,YAA3B;AACA,QAAMC,WAAY,GAAEF,aAAaG,SAAb,CAAuB,CAAvB,EAA0BH,aAAaI,WAAb,CAAyB,GAAzB,CAA1B,CAAyD,cAAa1B,EAAG,IAAI,IAAI2B,IAAJ,EAAD,CAAaC,WAAb,EAA2B,EAA3H;;AAEA,4BACEb,KADF;AAGIc,eAAWL,QAHf;AAIIM,YAAQhB;AAJZ,KAKOO,UALP;AAMIU,UAAM,CAAC/B,EAAD,EAAK,gBAAL,EAAuBW,YAAvB,EAAqCE,QAArC;AANV,MAQEmB,WAAW,wBACT,GADS,EAETA,OAFS,EAGT,6BAHS,EAITxC,GAJS,CARb,EAcEY,SAAS,wBACPA,MAAM6B,SADC,EAEP7B,KAFO,EAGPA,MAAM8B,OAHC,EAIP1C,GAJO,CAdX;AAqBD,CA3CD;;AA6CA;AACAH,OAAOoB,IAAP,CAAY,SAAZ,EAAuB,CAAClB,GAAD,EAAMC,GAAN,KAAc;AACnC,QAAM,EAAE2C,WAAF,EAAeC,WAAf,KAA+B7C,IAAIiB,IAAzC;AACA,MAAI,2BAAY4B,WAAZ,CAAJ,EAA8B;AAC5B,2BACEA,WADF,EAEGC,IAAD,IAAU;AACR,YAAMvB,cAAcuB,KAAKC,YAAL,CAAkBC,WAAtC;;AAEA,qCACEzB,WADF,EAEEqB,WAFF,EAGEH,WAAW1B,QAAQC,GAAR,CAAYyB,OAAZ,CAHb,EAIE5B,SAASE,QAAQC,GAAR,CAAYH,KAAZ,CAJX;AAMD,KAXH,EAYEA,SAAS,wBACPA,MAAMoC,UADC,EAEPpC,MAAMqC,QAFC,EAGP,2CAHO,EAIPjD,GAJO,CAZX;AAkBD,GAnBD,MAmBO;AACL,4BACE,GADF,EAEE,EAAE4C,WAAF,EAFF,EAGE,+CAHF,EAIE5C,GAJF;AAMD;AACF,CA7BD;;AA+BA;kBACeH,M","file":"campaigns.js","sourcesContent":["// Create API Users Router\nimport { Router } from 'express';\nimport multer from 'multer';\n\nimport cloudinary from 'cloudinary';\nimport dotenv from 'dotenv';\n\nimport { getUserInfo } from '../models/Auth0';\nimport { getCampaignContent, createCampaign } from '../models/campaigns';\nimport jsonResponse from '../helpers/response';\nimport uploadImage from '../models/Cloudinary';\nimport requireAuth from '../helpers/requireAuth';\n\n\nconst { CLOUDINARY_NAME, CLOUDINARY_KEY, CLOUDINARY_SECRET } = dotenv.config().parsed;\n\ncloudinary.config({\n  cloud_name: CLOUDINARY_NAME,\n  api_key: CLOUDINARY_KEY,\n  api_secret: CLOUDINARY_SECRET,\n});\n\nconst upload = multer();\nconst router = Router();\n\n/*\n******CAMPAIGN ROUTES******\n*/\n\n// Returns the list of campaigns based on the search as sort queries.\nrouter.get('/', (req, res) => {\n  if (Object.keys(req.query).length > 0) {\n    const search = req.query.search;\n    const sort = req.query.sort;\n    if (sort && search) {\n      res.send(`\n        Returns campaigns filtered by ${search} and sorted by ${sort}.\n      `);\n    } else if (sort) {\n      res.send(`\n        Returns all campaigns sorted by ${sort}.\n      `);\n    } else if (search) {\n      res.send(`\n        Returns campaigns filtered by ${req.query.search}\n      `);\n    }\n  } else {\n    res.send('Returns all campaigns paginated.');\n  }\n});\n\n// Returns the information for the campaign with the identity param.\nrouter.get('/:campaignId', (req, res) => {\n  const id = req.params.campaignId;\n  getCampaignContent(\n    id,\n    results => jsonResponse(\n      200,\n      results,\n      `This is the content for the campaign id ${id}`,\n      res,\n    ),\n    (error) => {\n      if (Object.keys(error).length) {\n        return jsonResponse(\n          500,\n          error,\n          'There was an error on the server.',\n          res,\n        );\n      }\n      return jsonResponse(\n        404,\n        error,\n        'You are trying to access a campaign that doesn\\'t exist.',\n        res,\n      );\n    },\n  );\n});\n\n// Accepts information changes to a campaign with the campaignId param.\n// Returns the update campaign information.\nrouter.patch('/edit/:campaignId', (req, res) => {\n  const id = req.params.campaignId;\n  console.log(req.body);\n});\n\nrouter.post('/upload/photo/:campaignId', upload.single('file'), (req, res) => {\n  const id = req.params.campaignId;\n  const { campaignName, imageType, imageAlt, nonprofitId } = req.body;\n  const image = req.file;\n\n  const imageDimensions = (imgType) => {\n    switch (imgType) {\n      case 'main':\n        return { width: 1440, height: 820 };\n      case 'left':\n        return { width: 235, height: 290 };\n      case 'right':\n        return { width: 235, height: 290 };\n      default:\n        return { width: 235, height: 290 };\n    }\n  };\n\n  const dimensions = imageDimensions(imageType);\n  const originalName = image.originalname;\n  const fileName = `${originalName.substring(0, originalName.lastIndexOf('.'))}-campaignId${id}-${(new Date()).toISOString()}`;\n\n  uploadImage(\n    image,\n    {\n      public_id: fileName,\n      folder: nonprofitId,\n      ...dimensions,\n      tags: [id, 'campaign-image', campaignName, imageAlt],\n    },\n    success => jsonResponse(\n      200,\n      success,\n      'Image created successfully.',\n      res,\n    ),\n    error => jsonResponse(\n      error.http_code,\n      error,\n      error.message,\n      res,\n    ),\n  );\n});\n\n// Accepts a new campaign information. Returns the new created campaign.\nrouter.post('/create', (req, res) => {\n  const { newCampaign, accessToken } = req.body;\n  if (requireAuth(accessToken)) {\n    getUserInfo(\n      accessToken,\n      (user) => {\n        const nonprofitId = user.app_metadata.nonProfitID;\n\n        createCampaign(\n          nonprofitId,\n          newCampaign,\n          success => console.log(success),\n          error => console.log(error),\n        );\n      },\n      error => jsonResponse(\n        error.statusCode,\n        error.original,\n        'There was an error getting the user info.',\n        res),\n    );\n  } else {\n    jsonResponse(\n      401,\n      { accessToken },\n      'The access token is not a valid access token.',\n      res,\n    );\n  }\n});\n\n// Exporting router as default.\nexport default router;\n"]}